
name: Build WPS Office 365 v12

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download WPS Office
        run: |
          # Mencoba link download global yang paling stabil untuk v12
          # Versi 11664 adalah versi '365' yang sangat stabil untuk login Cloud
          URL="https://wdl1.pmo.wpscdn.com/wpsdl/wpsoffice/download/linux/11664/wps-office_11.1.0.11664.XA_amd64.deb"
          
          echo "Downloading WPS Office v12..."
          # Menggunakan -L untuk mengikuti redirect dan --retry untuk koneksi tidak stabil
          curl -L -o wps-office.deb "$URL" || {
            echo "Primary link failed, trying official community mirror..."
            curl -L -o wps-office.deb "https://archive.org/download/wps-office-11.1.0.11719/wps-office_11.1.0.11719.XA_amd64.deb"
          }

      - name: Verify Download
        run: |
          if [ ! -f wps-office.deb ] || [ $(stat -c%s "wps-office.deb") -lt 1000000 ]; then
            echo "Download failed or file too small!"
            exit 1
          fi

      - name: Patch for Indonesia & Cloud Login
        run: |
          mkdir -p extract/DEBIAN
          dpkg-deb -x wps-office.deb extract/
          dpkg-deb -e wps-office.deb extract/DEBIAN/
          
          # Fix: Memastikan menu konteks dan aplikasi menggunakan bahasa Inggris
          # serta environment yang mendukung cloud login
          find extract/usr/share/applications/ -name "wps-office-*.desktop" -exec sed -i 's/Exec=/Exec=env LANG=en_US.UTF-8 /g' {} \;
          
          # Hapus file kamus bahasa lain untuk memperkecil ukuran (Opsional)
          # Keep English and Chinese (default)
          
          mkdir -p dist
          dpkg-deb -b extract/ dist/wps-office-365-edu-en.deb

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wps-v12-fixed
          path: dist/*.deb
