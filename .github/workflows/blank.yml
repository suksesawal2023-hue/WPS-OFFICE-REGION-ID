name: Build WPS Office 365 DEB

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget curl grep

      - name: Download WPS Office (Multi-source Fallback)
        run: |
          # Link versi 11.1.0.11719 (Versi 12/365 yang stabil)
          # Mencoba beberapa mirror resmi jika satu gagal
          URLS=(
            "https://wdl1.pmo.wpscdn.com/wpsdl/wpsoffice/download/linux/11719/wps-office_11.1.0.11719.XA_amd64.deb"
            "https://mirrors.pku.edu.cn/wps-office/linux/11719/wps-office_11.1.0.11719.XA_amd64.deb"
          )

          for url in "${URLS[@]}"; do
            echo "Attempting to download from: $url"
            if wget --timeout=15 --tries=2 -O wps-office.deb "$url"; then
              echo "Download successful!"
              SUCCESS=true
              break
            fi
          done

          if [ "$SUCCESS" != true ]; then
            echo "All download attempts failed. Checking for latest version link via community mirror..."
            # Fallback ke link archive jika server utama WPS down
            wget -O wps-office.deb https://github.com/mizuno-as/wps-office-linux-installer/releases/download/v11.1.0.11719/wps-office_11.1.0.11719.XA_amd64.deb
          fi

      - name: Build and Patch Package
        run: |
          mkdir -p extract/DEBIAN
          dpkg-deb -x wps-office.deb extract/
          dpkg-deb -e wps-office.deb extract/DEBIAN/
          
          # Optimasi Cloud Login & Region (English)
          # Memastikan konfigurasi cloud tidak terhambat locale
          echo "Setting Environment for Global/Indonesia Region..."
          sed -i 's/Exec=.*/Exec=env LANG=en_US.UTF-8 \/usr\/bin\/wps %f/' extract/usr/share/applications/wps-office-wps.desktop
          
          mkdir -p dist
          dpkg-deb -b extract/ dist/wps-office-365-v12-edu-indo.deb

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: wps-office-v12-deb
          path: dist/*.deb

