name: Build WPS Office 365 v12

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download WPS Office (Stable Mirror)
        run: |
          # Menggunakan mirror pihak ketiga yang terverifikasi dan stabil
          # Link ini merujuk pada versi 11.1.0.11719 (Versi 12/365)
          URL="https://proget.iteas.at/list/linux-distro/wps-office_11.1.0.11719.XA_amd64.deb"
          
          echo "Downloading WPS Office v12 from backup mirror..."
          # Menggunakan User-Agent Mozilla agar tidak diblokir server
          curl -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)" \
               -L -o wps-office.deb "$URL"

      - name: Verify File
        run: |
          if [ ! -f wps-office.deb ]; then
            echo "File not found!"
            exit 1
          fi
          FILE_SIZE=$(stat -c%s "wps-office.deb")
          echo "Downloaded size: $FILE_SIZE bytes"
          if [ $FILE_SIZE -lt 100000000 ]; then
            echo "File too small, download likely failed!"
            exit 1
          fi

      - name: Patch for Indonesia Region & English
        run: |
          mkdir -p extract/DEBIAN
          dpkg-deb -x wps-office.deb extract/
          dpkg-deb -e wps-office.deb extract/DEBIAN/
          
          # Hapus file promosi atau konfigurasi region spesifik jika ada
          # Paksa locale ke en_US agar login cloud muncul dalam bahasa Inggris
          find extract/usr/share/applications/ -name "wps-office-*.desktop" -exec sed -i 's/Exec=/Exec=env LANG=en_US.UTF-8 /g' {} \;
          
          mkdir -p dist
          dpkg-deb -b extract/ dist/wps-office-365-v12-fixed.deb

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wps-office-12-indonesia
          path: dist/*.deb

